@page "/Accounts"
@model TreeAccounts_saleInvice.Pages.AccountsModel
@{
    ViewData["Title"] = "Accounts"; 
}

<style>
    /* إظهار عناصر .htmx-indicator فقط أثناء الطلب */
    form .htmx-indicator {
        display: none;
    }

    form.htmx-request .htmx-indicator {
        display: flex;
    }

    form.htmx-request button[type="submit"] {
        pointer-events: none;
        opacity: 0.85;
    }


    /* سبينر داخل الزر (ثلاث نقاط نابضة) */
    .btn-spinner {
        margin-inline-start: .75rem;
        align-items: center;
        gap: .25rem;
    }

        .btn-spinner::before,
        .btn-spinner::after {
            content: '';
        }

        .btn-spinner,
        .btn-spinner::before,
        .btn-spinner::after {
            width: .45rem;
            height: .45rem;
            border-radius: 50%;
            background: #fff;
            animation: dotPulse 1s infinite ease-in-out;
            display: inline-flex;
        }

            .btn-spinner::before {
                animation-delay: .15s;
                margin-inline-end: .25rem;
            }

            .btn-spinner::after {
                animation-delay: .30s;
                margin-inline-start: .25rem;
            }

    @@keyframes dotPulse {
        0%, 80%, 100% {
            transform: scale(0.6);
            opacity: .6;
        }

        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    /* أوفرلاي يغطي الفورم */
    form {
        position: relative;
    }

    .save-overlay {
        position: absolute;
        inset: 0;
        background: rgba(2,2,2,.45);
        backdrop-filter: blur(2px);
        z-index: 10;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        gap: .75rem;
    }

    .save-text {
        font-weight: 700;
        color: #198754;
        letter-spacing: .3px;
        position: relative;
        display: grid;
        place-items: center;
    }

    /* Loader أنيق (مربعات تدور) */
    .loader {
        width: 90%;
        height: 50%;
        position: relative;
        display: grid;
        place-items: center;
    }

        .loader span {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #198754;
            border-radius: 3px;
            transform-origin: 32px 32px;
            animation: squareOrbit 1.2s linear infinite;
            box-shadow: 0 0 8px rgba(25,135,84,.5);
        }

            .loader span:nth-child(1) {
                transform: rotate(0deg) translate(20px);
                animation-delay: 0s;
            }

            .loader span:nth-child(2) {
                transform: rotate(90deg) translate(20px);
                animation-delay: .1s;
            }

            .loader span:nth-child(3) {
                transform: rotate(180deg) translate(20px);
                animation-delay: .2s;
            }

            .loader span:nth-child(4) {
                transform: rotate(270deg) translate(20px);
                animation-delay: .3s;
            }

    @@keyframes squareOrbit {
        0% {
            transform: rotate(var(--r,0deg)) translate(20px) scale(1);
            opacity: .9;
        }

        50% {
            transform: rotate(calc(var(--r,0deg) + 180deg)) translate(20px) scale(.8);
            opacity: .6;
        }

        100% {
            transform: rotate(calc(var(--r,0deg) + 360deg)) translate(20px) scale(1);
            opacity: .9;
        }
    }

 

    /* ---------------------------------
       4. الأيقونات ومؤشر التحميل
    --------------------------------- */
    .htmx-indicator {
        display: none;
        color: #28a745;
    }

    .htmx-request .htmx-indicator {
        display: inline-block;
    }

    .jstree-anchor {
        display: flex;
        align-items: center;
        gap: 5px;
    }

        .jstree-anchor i.fa {
            font-size: 0.85rem;
            transition: opacity 0.2s ease;
        }

            .jstree-anchor i.fa:hover {
                opacity: 1 !important;
            }

        /* إخفاء الأيقونات إلا عند hover على العقدة */
        .jstree-anchor:not(:hover) i.fa {
            opacity: 0;
        }

</style>
<!-- ============================================= -->
<!-- 1. تضمين أنماط jstree (يجب أن تكون داخل <head> أو قبل المحتوى) -->
<!-- ============================================= -->
<link rel="stylesheet" href="../assets/vendor/libs/jstree/jstree.css" />

<!-- ============================================= -->
<!-- 2. هيكل الصفحة الرئيسي -->
<!-- ============================================= -->
<div class="content-wrapper">

    <div class="container-xxl flex-grow-1 container-p-y">
        <!-- عرض رسائل التنبيه -->
        @if (!string.IsNullOrEmpty(Model.Message))
        {
            <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-danger") alert-dismissible" role="alert">
                @Model.Message
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
        <h4 class="breadcrumb-wrapper py-3 mb-4">
            <span class="text-muted fw-light">الأستاذ العام/</span> دليل الحسابات
        </h4>
        <!-- ============================================= -->
        <!-- 4. قسم إضافة احساب -->
        <!-- ============================================= -->
        <!-- شجرة الحسابات & اضافة حساب جديد -->
        <div class="row">
            <!-- Basic Layout -->
            <div class="col-xxl">
                <div class="card mb-4">
                    <!-- ============================================= -->
                    <!-- 3. قسم شجرة الحسابات -->
                    <!-- ============================================= -->


                    <div class="card-header d-flex justify-content-between align-items-center">
                      

                        <h5 class="mb-0">شجرة الحسابات </h5>
                    </div>
                    <div class="card-body">
                        <input type="text" id="treeSearch" placeholder="ابحث في الحسابات..." class="form-control mb-2" />
                        <div id="jstree-ajax"></div>


                    </div>


                </div>
            </div>
            <!-- Basic with Icons -->
            <div class="col-xxl">
                    <partial name="_CreateAccountPartial" model="Model.accounts" />
                  
   
            </div>
        </div>
          <div id="save-result" class="mt-3"></div>











        <!-- ============================================= -->
        <!-- 4. جدول الحسابات -->
        <!-- ============================================= -->
        <div class="card">
            <div class="card-datatable table-responsive pt-0">
                <table class="datatables-basic table table-bordered">
                    <thead>
                        <tr>
                            <th>رقم الحساب</th>
                            <th>اسم الحساب</th>
                            <th>حساب الأب</th>
                            <th>نوع الحساب</th>
                            <th>الحساب الختامي</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.accounts != null && Model.accounts.Any())
                        {
                            @foreach (var account in Model.accounts)
                            {
                                <tr data-account-id="@account.AccountNumber">
                                    <td>@account.AccountNumber</td>
                                    <td>@account.AccountName</td>
                                    <td>@account.FatherNumber</td>
                                    <td>
                                        @if (account.AccountType == "رئيسي")
                                        {
                                            <span class="badge bg-label-success rounded p-2">رئيسي</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-label-danger rounded p-2">فرعي</span>
                                        }
                                    </td>
                                    <td>@account.AccountReference</td>
                                    <td>
                                        <div class="d-inline-block">
                                            <button class="btn btn-sm btn-icon dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                                                <i class="bx bx-dots-vertical-rounded"></i>
                                            </button>
                                            <div class="dropdown-menu dropdown-menu-end">
                                                <a data-bs-toggle="modal"
                                                   data-bs-target="#referAndEarn"
                                                   data-invoice-id="@account.ID"
                                                   href="#"
                                                   class="dropdown-item details-record">
                                                    <i class="menu-icon tf-icons bx bx-spreadsheet"></i> تفاصيل
                                                </a>
                                                <a href="javascript:;"
                                                   hx-get="/Accounts?handler=EditAccount"
                                                   hx-target="#form-container"
                                                   hx-swap="outerHTML"
                                                   hx-vals='{"accountNumber":"@account.AccountNumber"}'
                                                   class="dropdown-item text-info ">
                                                    <i class="bx bx-edit"></i> تعديل
                                                </a>
                                               
                                                <div class="dropdown-divider"></div>
                                                <a href="javascript:;"
                                                   onclick="confirmDelete(@account.AccountNumber, this)"
                                                   data-account-id="@account.AccountNumber"
                                                   class="dropdown-item text-danger delete-record">
                                                    <i class="bx bx-trash"></i> حذف
                                                </a>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center">لا توجد حسابات لعرضها</td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- ============================================= -->
    <!-- 5. تضمين رمز الحماية من التزوير (CSRF Token) -->
    <!-- ============================================= -->
    @Html.AntiForgeryToken()

    <div class="content-backdrop fade"></div>
</div>

<!-- ============================================= -->
<!-- 6. تضمين السكربتات في نهاية الصفحة -->
<!-- ============================================= -->
@section Scripts {

    <!-- jstree JS -->
    <script src="../assets/vendor/libs/jstree/jstree.js"></script>

    <!-- ملف JavaScript الخاص بالصفحة  -->
    <script src="../js/Accounts.js"></script>

 
}